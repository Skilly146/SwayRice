# Constants
constants:
  home: "/home/landond"
  etc: "/etc"
  opt: "/opt"
  boot: "/boot"
  flash_uuid: ""

# Source from writable directories
source_directories:
  - "{home}"
  - "{etc}"
  - "{opt}"
  - "{boot}"

# Backup to BorgBase, Optiplex, disk, and flash drive in that order
repositories:
  - path: ssh://t0bf3d6b@t0bf3d6b.repo.borgbase.com/./repo
    label: BorgBase-Offsite
    encryption: repokey-blake2
  - path: "{home}/documents/backups/framework"
    label: OnDisk-Local
    encryption: repokey-blake2
  - path: ssh://landond@server:22/home/landond/data/borg/framework
    label: Server-Remote
    encryption: repokey-blake2
  #- path: ""
  #  label: FlashDrive-Local
  #  encryption: repokey-blake2

# Don't backup mounted drives
one_file_system: true

# Exclude files listed in exclude.txt
exclude_from:
  - "{home}/.config/borgmatic.d/exclude.txt"

# Mark directory for no backup by adding a .nobackup file
exclude_if_present: 
  - .nobackup

# Set repo password, will probably prompt user for bitwarden password
encryption_passcommand: rbw get "Fedora Backup" -f password

# Also options for secondly and minutely
# Pruning options: 12H, 7D, 4W, 12M, 2Y, and always keep last 72H
keep_within: 72H
keep_hourly: 12
keep_daily: 7
keep_weekly: 4
keep_monthly: 12
keep_yearly: 2

# Do a repo, data, and dry-extract check 
checks:
  - name: extract
    frequency: always
  - name: repository
    frequency: 1 week
  - name: data
    frequency: 2 weeks

commands:
  # Create backups of distrobox before creating an archive and delete them after
  #- before: configuration
  #  when: [create]
  #  run: 
  #    - backup-distrobox
  #- after: configuration
  #  when: [create]
  #  run: 
  #    - ls ~/documents/backups/distrobox | grep .backup && rm ~/documents/backups/distrobox/*.backup || echo "No distrobox backups to delete"
  # Check before each backup that the repo is available to avoid errors
  - before: action
    when: [create]
    run: 
      - check-borg-repo {repository_label}
  # Send notification if a backup fails
  - after: error
    run: 
      - notify-send "Borgmatic config {configuration_filename} encountered the error {error} on repo {repository}, with the output {output}"  

# Retry with delay
retries: 3
retry_wait: 5

# Max verbosity since it gets piped to a log, could add the file here but is currently redirected by cron
verbosity: 2

# Add btrfs support, need to clean up subvolumes
#btrfs:
